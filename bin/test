#!/bin/sh
setup() {
  echo $1:
  cd $1
  $(kill_server)
  bin/setup &
  cd ..
  until $(curl --output /dev/null --silent --head --fail http://localhost:6969/api/test); do sleep 1; done
}

test() {
  EBOSHI_API_SHOOTOUT_CURRENT_IMPL=$1 ruby test/test.rb
}

teardown() {
  $(kill_server)
  while $(curl --output /dev/null --silent --head --fail http://localhost:6969/api/test); do sleep 1; done
  echo ""
}

kill_server() {
  [ ! -z $(server_pid) ] && kill -INT $(server_pid)
}

server_pid() {
  lsof -i TCP:6969 | grep LISTEN | awk '{print $2}' | head -n1
}

setup $1 && test $1
teardown
